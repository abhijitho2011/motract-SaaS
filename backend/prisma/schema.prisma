generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(uuid())
  email          String?        @unique
  mobile         String         @unique
  password       String?
  role           Role
  name           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  workshopId     String?
  workshop       Workshop?      @relation(fields: [workshopId], references: [id])
  clientVehicles VehicleOwner[]

  @@map("users")
}

model Workshop {
  id               String          @id @default(uuid())
  name             String
  address          String?
  city             String?
  state            String?
  pincode          String?
  gstin            String?
  mobile           String
  email            String?
  logoUrl          String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  latitude         Float?
  longitude        Float?
  workingStartHour String          @default("09:00")
  workingEndHour   String          @default("19:00")
  slotDurationMin  Int             @default(30)
  workingDays      String[]        @default(["MON", "TUE", "WED", "THU", "FRI", "SAT"])
  bays             Bay[]
  customers        Customer[]
  expenses         Expense[]
  inventoryItems   InventoryItem[]
  invoices         Invoice[]
  jobCards         JobCard[]
  purchases        PurchaseOrder[]
  services         Service[]
  suppliers        Supplier[]
  users            User[]
  workshopBreaks   WorkshopBreak[]

  @@map("workshops")
}

model Make {
  id     String         @id @default(uuid())
  name   String         @unique
  models VehicleModel[]

  @@map("makes")
}

model VehicleModel {
  id                      String                    @id @default(uuid())
  name                    String
  makeId                  String
  InventoryVehicleMapping InventoryVehicleMapping[]
  make                    Make                      @relation(fields: [makeId], references: [id])
  variants                Variant[]

  @@unique([makeId, name])
  @@map("models")
}

model Variant {
  id       String       @id @default(uuid())
  name     String
  fuelType FuelType
  modelId  String
  model    VehicleModel @relation(fields: [modelId], references: [id])
  vehicles Vehicle[]

  @@unique([modelId, name, fuelType])
  @@map("variants")
}

model Vehicle {
  id            String         @id @default(uuid())
  regNumber     String         @unique
  chassisNumber String?
  engineNumber  String?
  vin           String?
  mfgYear       Int?
  variantId     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  jobCards      JobCard[]
  owners        VehicleOwner[]
  variant       Variant        @relation(fields: [variantId], references: [id])

  @@map("vehicles")
}

model VehicleOwner {
  id        String  @id @default(uuid())
  userId    String
  vehicleId String
  isPrimary Boolean @default(true)
  user      User    @relation(fields: [userId], references: [id])
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  @@unique([userId, vehicleId])
  @@map("vehicle_owners")
}

model Customer {
  id         String    @id @default(uuid())
  workshopId String
  name       String
  mobile     String
  email      String?
  address    String?
  gstin      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  workshop   Workshop  @relation(fields: [workshopId], references: [id])
  invoices   Invoice[]
  jobCards   JobCard[]

  @@unique([workshopId, mobile])
  @@map("customers")
}

model JobCard {
  id                    String         @id @default(uuid())
  workshopId            String
  vehicleId             String
  customerId            String
  stage                 JobStage       @default(CREATED)
  priority              JobPriority    @default(NORMAL)
  odometer              Int?
  fuelLevel             Int?
  entryTime             DateTime       @default(now())
  estimatedDeliveryTime DateTime?
  actualDeliveryTime    DateTime?
  advisorId             String?
  technicianId          String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  invoice               Invoice?
  customer              Customer       @relation(fields: [customerId], references: [id])
  vehicle               Vehicle        @relation(fields: [vehicleId], references: [id])
  workshop              Workshop       @relation(fields: [workshopId], references: [id])
  complaints            JobComplaint[]
  inspection            JobInspection?
  tasks                 JobItem[]
  parts                 JobPart[]

  @@map("job_cards")
}

model JobComplaint {
  id        String  @id @default(uuid())
  jobCardId String
  complaint String
  remark    String?
  jobCard   JobCard @relation(fields: [jobCardId], references: [id])

  @@map("job_complaints")
}

model JobInspection {
  id        String   @id @default(uuid())
  jobCardId String   @unique
  exterior  Json?
  interior  Json?
  tyres     Json?
  battery   String?
  documents Json?
  photos    String[]
  jobCard   JobCard  @relation(fields: [jobCardId], references: [id])

  @@map("job_inspections")
}

model JobItem {
  id               String  @id @default(uuid())
  jobCardId        String
  description      String
  price            Float
  gstPercent       Float   @default(18.0)
  isApproved       Boolean @default(false)
  completionStatus String?
  jobCard          JobCard @relation(fields: [jobCardId], references: [id])

  @@map("job_items")
}

model JobPart {
  id         String          @id @default(uuid())
  jobCardId  String
  itemId     String
  batchId    String?
  quantity   Float
  unitPrice  Float
  gstPercent Float
  totalPrice Float
  isApproved Boolean         @default(false)
  batch      InventoryBatch? @relation(fields: [batchId], references: [id])
  item       InventoryItem   @relation(fields: [itemId], references: [id])
  jobCard    JobCard         @relation(fields: [jobCardId], references: [id])

  @@map("job_parts")
}

model Category {
  id            String        @id @default(uuid())
  name          String
  subCategories SubCategory[]

  @@map("categories")
}

model SubCategory {
  id         String   @id @default(uuid())
  categoryId String
  name       String
  category   Category @relation(fields: [categoryId], references: [id])

  @@map("sub_categories")
}

model InventoryItem {
  id                 String                    @id @default(uuid())
  workshopId         String
  name               String
  brand              String?
  isOem              Boolean                   @default(false)
  hsnCode            String?
  taxPercent         Float                     @default(18.0)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  batches            InventoryBatch[]
  workshop           Workshop                  @relation(fields: [workshopId], references: [id])
  partNumbers        InventoryPartNumber[]
  compatibleVehicles InventoryVehicleMapping[]
  jobParts           JobPart[]

  @@map("inventory_items")
}

model InventoryPartNumber {
  id      String        @id @default(uuid())
  itemId  String
  skuCode String
  item    InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([itemId, skuCode])
  @@map("inventory_part_numbers")
}

model InventoryBatch {
  id            String        @id @default(uuid())
  itemId        String
  batchNumber   String?
  expiryDate    DateTime?
  quantity      Float
  purchasePrice Float
  salePrice     Float
  purchasedAt   DateTime      @default(now())
  item          InventoryItem @relation(fields: [itemId], references: [id])
  jobParts      JobPart[]

  @@map("inventory_batches")
}

model InventoryVehicleMapping {
  id        String        @id @default(uuid())
  itemId    String
  modelId   String
  variantId String?
  item      InventoryItem @relation(fields: [itemId], references: [id])
  model     VehicleModel  @relation(fields: [modelId], references: [id])

  @@map("inventory_vehicle_mapping")
}

model Supplier {
  id         String          @id @default(uuid())
  workshopId String
  name       String
  mobile     String
  gstin      String?
  address    String?
  orders     PurchaseOrder[]
  workshop   Workshop        @relation(fields: [workshopId], references: [id])

  @@map("suppliers")
}

model PurchaseOrder {
  id            String         @id @default(uuid())
  workshopId    String
  supplierId    String
  invoiceDate   DateTime
  invoiceNumber String?
  totalAmount   Float
  status        String
  createdAt     DateTime       @default(now())
  items         PurchaseItem[]
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  workshop      Workshop       @relation(fields: [workshopId], references: [id])

  @@map("purchases")
}

model PurchaseItem {
  id         String        @id @default(uuid())
  orderId    String
  itemName   String
  partNumber String?
  quantity   Float
  unitCost   Float
  taxPercent Float
  total      Float
  order      PurchaseOrder @relation(fields: [orderId], references: [id])

  @@map("purchase_items")
}

model Invoice {
  id            String      @id @default(uuid())
  workshopId    String
  customerId    String
  jobCardId     String?     @unique
  invoiceNumber String
  invoiceDate   DateTime    @default(now())
  type          InvoiceType
  totalLabor    Float       @default(0)
  totalParts    Float       @default(0)
  cgst          Float       @default(0)
  sgst          Float       @default(0)
  igst          Float       @default(0)
  discount      Float       @default(0)
  grandTotal    Float
  paidAmount    Float       @default(0)
  balance       Float       @default(0)
  customer      Customer    @relation(fields: [customerId], references: [id])
  jobCard       JobCard?    @relation(fields: [jobCardId], references: [id])
  workshop      Workshop    @relation(fields: [workshopId], references: [id])
  payments      Payment[]

  @@map("invoices")
}

model Payment {
  id        String      @id @default(uuid())
  invoiceId String
  amount    Float
  mode      PaymentMode
  reference String?
  date      DateTime    @default(now())
  invoice   Invoice     @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model Expense {
  id            String   @id @default(uuid())
  workshopId    String
  category      String
  amount        Float
  date          DateTime
  notes         String?
  attachmentUrl String?
  workshop      Workshop @relation(fields: [workshopId], references: [id])

  @@map("expenses")
}

model Bay {
  id         String              @id @default(uuid())
  workshopId String
  name       String
  type       BayType
  isActive   Boolean             @default(true)
  workshop   Workshop            @relation(fields: [workshopId], references: [id])
  services   ServiceBayMapping[]
  bookings   SlotBooking[]

  @@map("bays")
}

model Service {
  id          String              @id @default(uuid())
  workshopId  String
  name        String
  durationMin Int                 @default(30)
  price       Float?
  allowedBays ServiceBayMapping[]
  workshop    Workshop            @relation(fields: [workshopId], references: [id])

  @@map("services")
}

model ServiceBayMapping {
  id        String  @id @default(uuid())
  serviceId String
  bayId     String
  bay       Bay     @relation(fields: [bayId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])

  @@unique([serviceId, bayId])
  @@map("service_bay_mapping")
}

model SlotBooking {
  id        String     @id @default(uuid())
  bayId     String
  date      DateTime
  startTime String
  endTime   String
  status    SlotStatus
  jobCardId String?
  createdAt DateTime   @default(now())
  bay       Bay        @relation(fields: [bayId], references: [id])

  @@map("slot_bookings")
}

model WorkshopBreak {
  id         String   @id @default(uuid())
  workshopId String
  title      String
  startTime  String
  endTime    String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  @@map("workshop_breaks")
}

enum Role {
  SUPER_ADMIN
  WORKSHOP_ADMIN
  WORKSHOP_MANAGER
  TECHNICIAN
  CLIENT
  RSA_PROVIDER
  SUPPLIER
}

enum FuelType {
  PETROL
  DIESEL
  CNG
  ELECTRIC
  HYBRID
}

enum JobStage {
  CREATED
  INSPECTION
  ESTIMATE
  CUSTOMER_APPROVAL
  WORK_IN_PROGRESS
  QC
  BILLING
  DELIVERY
  CLOSED
}

enum JobPriority {
  NORMAL
  URGENT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BayType {
  SERVICE
  WASHING
  ALIGNMENT
  ELECTRICAL
  GENERAL
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

enum InvoiceType {
  JOB_CARD
  COUNTER_SALE
}

enum PaymentMode {
  CASH
  UPI
  CARD
  BANK_TRANSFER
  CREDIT
}

enum TxnType {
  CREDIT
  DEBIT
}
